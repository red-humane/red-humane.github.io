<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Talk To Me - Global Chat</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #000;
      color: #fff;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 16px 20px;
      background: #111;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      font-size: 18px;
      font-weight: 600;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #888;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
      transition: all 0.3s;
    }

    .status-dot.connected {
      background: #4CAF50;
      box-shadow: 0 0 8px #4CAF50;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #messages::-webkit-scrollbar {
      width: 6px;
    }

    #messages::-webkit-scrollbar-track {
      background: transparent;
    }

    #messages::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }

    #messages::-webkit-scrollbar-thumb:hover {
      background: #444;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state h2 {
      font-size: 20px;
      margin-bottom: 8px;
      font-weight: 500;
      color: #888;
    }

    .empty-state p {
      font-size: 14px;
      color: #555;
    }

    .setup-notice {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 20px;
      margin: 20px;
      color: #e53935;
    }

    .setup-notice h3 {
      margin-bottom: 10px;
      font-size: 16px;
    }

    .setup-notice p {
      font-size: 13px;
      line-height: 1.6;
      color: #ccc;
      margin-bottom: 8px;
    }

    .setup-notice code {
      background: #000;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      color: #4CAF50;
    }

    .message {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
      animation: slideIn 0.3s ease;
      font-size: 15px;
      line-height: 1.4;
      position: relative;
      transition: opacity 0.5s ease;
    }

    .message.fading {
      opacity: 0.5;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.received {
      align-self: flex-start;
      background: #1a1a1a;
      border-bottom-left-radius: 4px;
    }

    .message.sent {
      align-self: flex-end;
      background: #e53935;
      border-bottom-right-radius: 4px;
    }

    .message-header {
      display: none;
    }

    .message-user {
      display: none;
    }

    .message-text {
      /* Only message text visible */
    }

    .message-time {
      display: none;
    }

    .message-expiry {
      display: none;
    }

    .input-area {
      padding: 16px 20px;
      background: #000;
    }

    .input-container {
      height: 48px;
      border-radius: 24px;
      background: #111;
      border: 1px solid #222;
      display: flex;
      flex-direction: row;
      align-items: center;
      transition: all 0.2s;
    }

    .input-container:focus-within {
      border-color: #333;
    }

    #messageInput {
      flex: 1;
      background: none;
      border: none;
      color: #fff;
      font-size: 16px;
      outline: none;
      padding: 0 16px;
    }

    #messageInput::placeholder {
      color: #666;
    }

    .send-button {
      padding: 0 12px;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      border: none;
      background: none;
    }

    .send-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #555;
      transition: background 0.2s;
    }

    .send-dot.active {
      background: #e53935;
    }

    .send-button:disabled {
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      .message {
        max-width: 85%;
      }

      .header-title {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-title">Talk To Me</div>
      <div class="status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Connecting...</span>
      </div>
    </div>

    <div id="messages">
      <div class="empty-state" id="emptyState">
        <h2>Talk to me</h2>
      </div>
      <div class="setup-notice" id="setupNotice">
        <h3>‚öôÔ∏è Firebase Setup Required</h3>
        <p><strong>Step 1:</strong> Go to <a href="https://console.firebase.google.com" target="_blank" style="color: #4CAF50;">Firebase Console</a></p>
        <p><strong>Step 2:</strong> Create a new project (free)</p>
        <p><strong>Step 3:</strong> Add a Web App and copy the config</p>
        <p><strong>Step 4:</strong> Replace the <code>firebaseConfig</code> object in the code (line 230)</p>
        <p><strong>Step 5:</strong> Enable Realtime Database in Firebase Console</p>
        <p style="margin-top: 12px; font-size: 12px; color: #888;">üí° Once configured, this notice will disappear automatically</p>
      </div>
    </div>

    <div class="input-area">
      <div class="input-container">
        <input 
          type="text" 
          id="messageInput" 
          placeholder="Message..." 
          autocomplete="off"
          maxlength="500"
        >
        <button id="sendBtn" class="send-button" disabled>
          <div class="send-dot" id="sendDot"></div>
        </button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, push, onChildAdded, onChildRemoved, query, orderByChild, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // ============================================
    // üî• FIREBASE CONFIG - REPLACE WITH YOUR OWN
    // ============================================
    const firebaseConfig = {
  apiKey: "AIzaSyCMtsjJCtHGZpYbt2IM4meuiqy5kL-axdo",
  authDomain: "talk-to-me-e3422.firebaseapp.com",
  databaseURL: "https://talk-to-me-e3422-default-rtdb.firebaseio.com",
  projectId: "talk-to-me-e3422",
  storageBucket: "talk-to-me-e3422.firebasestorage.app",
  messagingSenderId: "584227885310",
  appId: "1:584227885310:web:0003e3fd1f2f12ae48d5af",
  measurementId: "G-W45MRMR923"
};

    // Check if Firebase is configured
    const isConfigured = !firebaseConfig.apiKey.includes('YOUR_');

    // State
    const state = {
      messages: new Map(),
      userId: generateUserId(),
      isConnected: false,
      expiryTimers: new Map()
    };

    // Elements
    const elements = {
      messages: document.getElementById('messages'),
      emptyState: document.getElementById('emptyState'),
      setupNotice: document.getElementById('setupNotice'),
      statusDot: document.getElementById('statusDot'),
      statusText: document.getElementById('statusText'),
      messageInput: document.getElementById('messageInput'),
      sendBtn: document.getElementById('sendBtn'),
      sendDot: document.getElementById('sendDot')
    };

    // Constants
    const MESSAGE_EXPIRY_TIME = 3 * 60 * 1000; // 3 minutes in milliseconds

    // Generate unique user ID
    function generateUserId() {
      return `user-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    }

    // Format timestamp
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Calculate time remaining
    function getTimeRemaining(createdAt) {
      const now = Date.now();
      const elapsed = now - createdAt;
      const remaining = MESSAGE_EXPIRY_TIME - elapsed;
      
      if (remaining <= 0) return 'Expiring...';
      
      const minutes = Math.floor(remaining / 60000);
      const seconds = Math.floor((remaining % 60000) / 1000);
      
      if (minutes > 0) {
        return `${minutes}m ${seconds}s left`;
      }
      return `${seconds}s left`;
    }

    // Update connection status
    function updateConnectionStatus(connected) {
      state.isConnected = connected;
      elements.statusDot.classList.toggle('connected', connected);
      elements.statusText.textContent = connected ? 'Online' : 'Connecting...';
      elements.sendBtn.disabled = !connected || elements.messageInput.value.trim().length === 0;
      
      if (connected && isConfigured) {
        elements.setupNotice.style.display = 'none';
      }
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Add message to state
    function addMessage(messageId, data) {
      if (!data || !data.text || !data.userId || !data.timestamp) return;
      
      // Check if message already exists
      if (state.messages.has(messageId)) return;

      const messageData = {
        id: messageId,
        text: data.text,
        userId: data.userId,
        timestamp: data.timestamp,
        isMine: data.userId === state.userId
      };

      state.messages.set(messageId, messageData);
      
      // Setup expiry timer for UI update
      setupExpiryTimer(messageId, data.timestamp);
      
      renderMessages();
    }

    // Setup expiry countdown timer
    function setupExpiryTimer(messageId, createdAt) {
      // Clear existing timer
      if (state.expiryTimers.has(messageId)) {
        clearInterval(state.expiryTimers.get(messageId));
      }

      // Update countdown every second
      const timer = setInterval(() => {
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (!messageElement) {
          clearInterval(timer);
          state.expiryTimers.delete(messageId);
          return;
        }

        const expiryElement = messageElement.querySelector('.message-expiry');
        if (expiryElement) {
          const remaining = MESSAGE_EXPIRY_TIME - (Date.now() - createdAt);
          
          if (remaining <= 30000) { // Last 30 seconds
            messageElement.classList.add('fading');
          }
          
          if (remaining <= 0) {
            clearInterval(timer);
            state.expiryTimers.delete(messageId);
          } else {
            expiryElement.textContent = getTimeRemaining(createdAt);
          }
        }
      }, 1000);

      state.expiryTimers.set(messageId, timer);
    }

    // Remove message from state
    function removeMessage(messageId) {
      state.messages.delete(messageId);
      
      // Clear timer
      if (state.expiryTimers.has(messageId)) {
        clearInterval(state.expiryTimers.get(messageId));
        state.expiryTimers.delete(messageId);
      }
      
      renderMessages();
    }

    // Render all messages - FIXED SORTING
    function renderMessages() {
      // Convert to array and sort by timestamp (ASCENDING ORDER - oldest first)
      const messagesArray = Array.from(state.messages.values())
        .sort((a, b) => a.timestamp - b.timestamp); // This ensures correct chronological order

      if (messagesArray.length === 0) {
        elements.emptyState.style.display = 'block';
        return;
      }

      elements.emptyState.style.display = 'none';

      const html = messagesArray.map(msg => {
        const safeText = escapeHtml(msg.text);
        const userName = msg.userId.split('-')[1]?.substr(0, 6) || 'unknown';
        const timeRemaining = getTimeRemaining(msg.timestamp);
        const isExpiringSoon = (MESSAGE_EXPIRY_TIME - (Date.now() - msg.timestamp)) <= 30000;
        
        return `
          <div class="message ${msg.isMine ? 'sent' : 'received'} ${isExpiringSoon ? 'fading' : ''}" data-message-id="${msg.id}">
            <div class="message-text">${safeText}</div>
          </div>
        `;
      }).join('');

      elements.messages.innerHTML = html;
      if (isConfigured) {
        elements.setupNotice.style.display = 'none';
      } else {
        elements.messages.insertAdjacentElement('afterbegin', elements.setupNotice);
      }

      // Auto-scroll to bottom with smooth behavior
      requestAnimationFrame(() => {
        elements.messages.scrollTop = elements.messages.scrollHeight;
      });
    }

    // Send message
    async function sendMessage() {
      const text = elements.messageInput.value.trim();
      
      if (!text || !state.isConnected || !isConfigured) return;

      try {
        const messageData = {
          text,
          userId: state.userId,
          timestamp: Date.now(),
          expiresAt: Date.now() + MESSAGE_EXPIRY_TIME
        };

        await push(messagesRef, messageData);

        // Clear input
        elements.messageInput.value = '';
        elements.sendBtn.disabled = true;
        elements.sendDot.classList.remove('active');
        elements.messageInput.focus();
      } catch (error) {
        console.error('Error sending message:', error);
        elements.statusText.textContent = 'Error sending';
        setTimeout(() => {
          if (state.isConnected) {
            elements.statusText.textContent = 'Online';
          }
        }, 2000);
      }
    }

    // Initialize Firebase
    let db, messagesRef;

    if (isConfigured) {
      try {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        messagesRef = ref(db, 'messages');

        // Listen for new messages - ordered by timestamp
        const messagesQuery = query(messagesRef, orderByChild('timestamp'), limitToLast(100));
        
        onChildAdded(messagesQuery, (snapshot) => {
          const data = snapshot.val();
          const messageId = snapshot.key;
          
          // Check if message should still exist
          const now = Date.now();
          if (data.expiresAt && data.expiresAt > now) {
            addMessage(messageId, data);
            
            // Schedule deletion in Firebase
            const timeUntilExpiry = data.expiresAt - now;
            setTimeout(() => {
              // Message will be removed by Firebase Rules or manual cleanup
            }, timeUntilExpiry);
          }
        });

        // Listen for removed messages
        onChildRemoved(messagesQuery, (snapshot) => {
          removeMessage(snapshot.key);
        });

        updateConnectionStatus(true);
        console.log('Firebase connected successfully');
      } catch (error) {
        console.error('Firebase initialization error:', error);
        updateConnectionStatus(false);
      }
    } else {
      console.warn('Firebase not configured. Please add your Firebase config.');
      elements.setupNotice.style.display = 'block';
    }

    // Event listeners
    elements.sendBtn.addEventListener('click', sendMessage);

    elements.messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Enable send button when input has text
    elements.messageInput.addEventListener('input', () => {
      const hasText = elements.messageInput.value.trim().length > 0;
      elements.sendBtn.disabled = !state.isConnected || !hasText || !isConfigured;
      
      // Update dot color
      if (hasText) {
        elements.sendDot.classList.add('active');
      } else {
        elements.sendDot.classList.remove('active');
      }
    });

    // Focus input on load
    if (isConfigured) {
      elements.messageInput.focus();
    }

    console.log('Chat initialized with ID:', state.userId);
  </script>
</body>
</html>
