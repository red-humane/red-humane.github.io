<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Talk To Me - Global Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/radix.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/store.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #000;
      color: #fff;
      height: 100vh;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
    }

    .status-bar {
      padding: 12px 16px;
      background: #111;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-text {
      font-size: 12px;
      color: #888;
    }

    #messages {
      height: calc(100vh - 120px);
      overflow-y: auto;
      padding: 16px;
      padding-bottom: 100px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      -webkit-overflow-scrolling: touch;
    }

    #messages::-webkit-scrollbar {
      width: 4px;
      background: transparent;
    }

    #messages::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 2px;
    }

    .empty {
      text-align: center;
      margin-top: 40px;
      color: #666;
      padding: 40px 20px;
    }

    .empty h2 {
      font-size: 18px;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .empty p {
      color: #444;
      font-size: 14px;
    }

    .message {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 16px;
      word-wrap: break-word;
      animation: slideIn 0.2s ease;
      font-size: 16px;
      line-height: 1.4;
      position: relative;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.received {
      align-self: flex-start;
      background: #0f0f0f;
      border-bottom-left-radius: 4px;
    }

    .message.sent {
      align-self: flex-end;
      background: #e53935;
      border-bottom-right-radius: 4px;
    }

    .message-time {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 4px;
      text-align: right;
    }

    .message-user {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 2px;
    }

    /* Hidden for app */
    .app-hidden {
      display: none !important;
    }

    /* Connection status */
    .connection-status {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #666;
      z-index: 1000;
    }

    .connection-status.connected {
      background: #4CAF50;
      box-shadow: 0 0 10px #4CAF50;
    }
  </style>
</head>
<body>
  <!-- Connection indicator -->
  <div class="connection-status" id="connectionStatus"></div>

  <!-- Status Bar (visible in web, hidden in app) -->
  <div class="status-bar app-hidden" id="statusBar">
    <div class="status-text" id="userInfo">Connecting...</div>
    <div class="status-text" id="messageCount">0 messages</div>
  </div>

  <!-- Messages container -->
  <div id="messages">
    <div class="empty" id="emptyState">
      <h2>Global Chat Room</h2>
      <p>Connecting to decentralized network...</p>
    </div>
  </div>

  <!-- Web input area (hidden in app) -->
  <div class="app-hidden" id="webInputArea" style="position: fixed; bottom: 0; left: 0; right: 0; padding: 16px; background: #000; border-top: 1px solid #222;">
    <div style="display: flex; gap: 10px; align-items: center; background: #111; border: 1px solid #333; border-radius: 24px; padding: 0 16px; height: 48px;">
      <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off" style="flex: 1; background: none; border: none; color: #fff; font-size: 16px; outline: none;">
      <button id="sendBtn" style="width: 32px; height: 32px; border-radius: 50%; border: none; background: #333; color: white; font-size: 18px; cursor: pointer;">â†‘</button>
    </div>
  </div>

  <script>
    // ========== CONFIGURATION ==========
    const CONFIG = {
      // Public Gun peers (decentralized network)
      PEERS: [
        'https://gun-manhattan.herokuapp.com/gun',
        'https://gun-us.herokuapp.com/gun',
        'https://peer.wallie.io/gun',
        'https://gun-vm.herokuapp.com/gun'
      ],
      CHAT_ROOM: 'talk-to-me-global-v2',
      MAX_MESSAGES: 1000,
      SYNC_INTERVAL: 5000
    };

    // ========== STATE ==========
    let state = {
      messages: [],
      userId: null,
      isConnected: false,
      messageCount: 0
    };

    // ========== ELEMENTS ==========
    const elements = {
      messages: document.getElementById('messages'),
      emptyState: document.getElementById('emptyState'),
      connectionStatus: document.getElementById('connectionStatus'),
      userInfo: document.getElementById('userInfo'),
      messageCount: document.getElementById('messageCount'),
      messageInput: document.getElementById('messageInput'),
      sendBtn: document.getElementById('sendBtn')
    };

    // ========== UTILITIES ==========
    const utils = {
      log: (msg) => {
        console.log(`[Chat] ${msg}`);
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'log',
            message: msg
          }));
        }
      },

      error: (msg) => {
        console.error(`[Chat] ${msg}`);
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'error',
            message: msg
          }));
        }
      },

      formatTime: (timestamp) => {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      },

      generateUserId: () => {
        const prefix = window.ReactNativeWebView ? 'app' : 'web';
        return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      }
    };

    // ========== GUN SETUP ==========
    let gun, chat;

    function initGun() {
      try {
        utils.log('ðŸ”Œ Initializing Gun.js...');

        gun = Gun({
          peers: CONFIG.PEERS,
          localStorage: false,
          radisk: false,
          axe: false
        });

        // Get chat room reference
        chat = gun.get(CONFIG.CHAT_ROOM);

        // Generate user ID
        state.userId = utils.generateUserId();
        utils.log(`ðŸ‘¤ User ID: ${state.userId}`);

        // Listen for connection status
        gun.on('opt', (context) => {
          if (context.once) return;
          
          if (context.peer && !state.isConnected) {
            state.isConnected = true;
            elements.connectionStatus.classList.add('connected');
            utils.log('âœ… Connected to Gun network');
            updateStatus();
          }
        });

        // Load existing messages
        loadMessages();

        // Subscribe to new messages
        subscribeToMessages();

        // Update status
        updateStatus();

      } catch (error) {
        utils.error(`Failed to initialize Gun: ${error.message}`);
      }
    }

    // ========== MESSAGE HANDLING ==========
    function loadMessages() {
      utils.log('ðŸ“¥ Loading messages...');
      
      chat.get('messages').map().once((data, id) => {
        if (data && data.text && data.userId && data.timestamp) {
          addMessageToState(data, id);
        }
      });
    }

    function subscribeToMessages() {
      chat.get('messages').map().on((data, id) => {
        if (data && data.text && data.userId && data.timestamp) {
          addMessageToState(data, id);
        }
      });
    }

    function addMessageToState(data, id) {
      // Check if message already exists
      const exists = state.messages.some(m => 
        m.id === id || (m.timestamp === data.timestamp && m.userId === data.userId)
      );

      if (!exists) {
        const message = {
          id: id,
          text: data.text,
          userId: data.userId,
          timestamp: data.timestamp,
          isMine: data.userId === state.userId
        };

        state.messages.push(message);
        
        // Sort by timestamp
        state.messages.sort((a, b) => a.timestamp - b.timestamp);
        
        // Keep only last MAX_MESSAGES
        if (state.messages.length > CONFIG.MAX_MESSAGES) {
          state.messages = state.messages.slice(-CONFIG.MAX_MESSAGES);
        }

        state.messageCount = state.messages.length;
        renderMessages();
        updateStatus();

        // Notify app
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'messageReceived',
            count: state.messageCount
          }));
        }
      }
    }

    // ========== RENDERING ==========
    function renderMessages() {
      if (state.messages.length === 0) {
        elements.emptyState.style.display = 'block';
        return;
      }

      elements.emptyState.style.display = 'none';
      
      elements.messages.innerHTML = state.messages.map(msg => {
        const isMine = msg.userId === state.userId;
        const safeText = msg.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        
        return `
          <div class="message ${isMine ? 'sent' : 'received'}">
            ${!isMine ? `<div class="message-user">User ${msg.userId.substr(0, 8)}</div>` : ''}
            <div>${safeText}</div>
            <div class="message-time">${utils.formatTime(msg.timestamp)}</div>
          </div>
        `;
      }).join('');

      // Scroll to bottom
      setTimeout(() => {
        elements.messages.scrollTop = elements.messages.scrollHeight;
      }, 100);
    }

    // ========== SENDING MESSAGES ==========
    function sendMessage(text) {
      if (!text || !text.trim()) {
        utils.log('âš ï¸ Empty message');
        return;
      }

      if (!gun || !state.userId) {
        utils.error('Gun not initialized');
        return;
      }

      const messageData = {
        text: text.trim(),
        userId: state.userId,
        timestamp: Date.now()
      };

      const messageId = `msg-${messageData.timestamp}-${Math.random().toString(36).substr(2, 9)}`;

      utils.log(`ðŸ“¤ Sending: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`);

      // Save to Gun
      chat.get('messages').get(messageId).put(messageData);

      // Add to local state immediately for instant feedback
      addMessageToState({
        ...messageData,
        id: messageId
      }, messageId);

      // Notify app
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({
          type: 'messageSent',
          text: text.trim(),
          timestamp: messageData.timestamp
        }));
      }
    }

    // ========== STATUS UPDATES ==========
    function updateStatus() {
      if (elements.userInfo) {
        elements.userInfo.textContent = state.userId ? 
          `User: ${state.userId.substr(0, 10)}...` : 'Connecting...';
      }
      
      if (elements.messageCount) {
        elements.messageCount.textContent = `${state.messageCount} messages`;
      }
    }

    // ========== EVENT LISTENERS ==========
    function setupEventListeners() {
      // Web input handling (only if not in app)
      if (!window.ReactNativeWebView) {
        elements.messageInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            const text = elements.messageInput.value.trim();
            if (text) {
              sendMessage(text);
              elements.messageInput.value = '';
            }
          }
        });

        elements.sendBtn.addEventListener('click', () => {
          const text = elements.messageInput.value.trim();
          if (text) {
            sendMessage(text);
            elements.messageInput.value = '';
          }
        });

        elements.messageInput.focus();
      }

      // App message handling
      if (window.ReactNativeWebView) {
        window.addEventListener('message', (event) => {
          try {
            const data = JSON.parse(event.data);
            
            if (data.type === 'sendMessage' && data.text) {
              sendMessage(data.text);
            }
            
            if (data.type === 'getStatus') {
              window.ReactNativeWebView.postMessage(JSON.stringify({
                type: 'status',
                messages: state.messageCount,
                userId: state.userId,
                connected: state.isConnected
              }));
            }
          } catch (e) {
            utils.error(`Message parse error: ${e.message}`);
          }
        });

        // Also handle the older 'message' event for React Native WebView
        document.addEventListener('message', (event) => {
          window.dispatchEvent(new MessageEvent('message', { data: event.data }));
        });
      }
    }

    // ========== INITIALIZATION ==========
    function init() {
      utils.log('ðŸš€ Starting chat application...');
      
      // Check if running in app
      const isInApp = window.ReactNativeWebView !== undefined;
      utils.log(`ðŸ“± Mode: ${isInApp ? 'App' : 'Web'}`);
      
      if (isInApp) {
        // Hide web elements in app
        document.querySelectorAll('.app-hidden').forEach(el => {
          el.classList.add('app-hidden');
        });
        elements.messages.style.height = '100vh';
      }

      // Initialize Gun.js
      initGun();

      // Setup event listeners
      setupEventListeners();

      // Periodically sync
      setInterval(() => {
        if (gun && state.isConnected) {
          // Force sync with peers
          chat.get('messages').map().once(() => {});
        }
      }, CONFIG.SYNC_INTERVAL);

      utils.log('âœ… Chat ready!');
      
      // Notify app we're ready
      if (window.ReactNativeWebView) {
        setTimeout(() => {
          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'ready',
            userId: state.userId
          }));
        }, 1000);
      }
    }

    // Start everything
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
